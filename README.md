# TDC (top-down-craft)

Я очень люблю Valheim. То есть выживалки. С этого все и началось. Зачем вечно делать платформеры и учиться на них, когда...

Когда можно поставить себе челендж сделать за 2 дня скелет выживалки, где ты можешь ~~грабить корованы~~, добывать ресуры и крафтить новые предметы не зная практически ничего о Godot!!! (то есть можно что-то ломать, оттуда что-то падает, подбирается и отображается в инвентаре, где можно скрафтить по рецепту новый предмет и поставить его на уровне)

Короче...

## Что уже сделано

### Разное

- Уровень в 1920х1080, перезапускается на R и закрывается на Esc
- На 4-ый день экспортировал проект в Web (GitHub -> Vercel) И ПОЧЕМУ-ТО НЕ РАБОТАЕТ ИНВЕНТАРЬ В ВЕБ БИЛДЕ (WTF)
- Добавил прикольные шрифты

### Игрок

- Есть игрок (`Player`, `CharacterBody2D`)
- Игрок нарисован
- Игрок передвигается на WASD
- Игрок смотрит на мышь (крутится его обьект)
- При клике проигрывается анимация удара меча (крутится реальный обьект, анимация не фиктивная)
- Меч это отдельная нода в дереве игрока
- Направление удара меча всегда следует за мышкой (атакует туда, куда смотрит игрок)
- Когда игрок поворачивается во время атаки, то меч перестает следовать его взгляду (иначе это выглядело очень странно)
- Когда меч с чемто соприкасается, то вызывается сигнал атаки

### Обьекты

- Есть кусты (`ItemObject`, `StaticBody2D`)
- Куст нарисован
- Куст имеет хп
- Куст при попадании мечом получает урон и мигает (`sprite.modulate`)
- На кусте в Loot Settings можно указать какой предмет будет выпадать (`PackedScene`), количество и шанс выпадения
- С куста падает дерево в количестве 1-3 с 75% шансом

### Предметы

- Дерево нарисовано и создан ресурс (`Resource`, `.tres`)
- Дерево (`Item`, `Area2D`) не имеет коллизии ~~и может быть подобрано игроком~~ (пока нет)
- Когда дерево спавнится, то определяется случайная позиция в радиусе от куста, куда движется предмет дерева (tween анимация) - кучка нескольких дропов распределена в радиусе, а не лежит друг на друге
- ~~Есть ягода, семя, но они пока ниоткуда не выпадают и не отображаются в игре (`Item`, `Area2D`)~~
- Ягода нарисована и создан ресурс
- Семя нарисовано и создан ресурс
- Камень, блюдо из ягод, топор, ой короче кучу всего добавил, даже стены (без логики, просто предметы)
- Подробное описание и доп характеристики в зависимости от кагории, типа у `Tool/Weapon` будет `damage` и `durability`

### Система лута

- Таблица лута (`LootTable`) с конфигом предметов для дропа (`ItemRes`)
- Кусту присваивается таблица, в которой настроено сразу какие вещи будут падать
- Теперь не нужно делать отдельные сцены для каждого нового предмета, тк они автоматически генерируются на базе конфига предмета лута (`ItemRes`) и сцены (`Item`)
- У игрока есть радиус сбора предметов
- ~~Когда предмет находится в этом радиусе, то пульсирует (hightlight), иначе лежит неподвижно~~ (изменено)
- При нажатии кнопки E, все предметы в радиусе сбора подбираются (анимация притягивания к игроку, добавление в инвентарь)
- Можно включить автолут на Q и тогда предметы будут собираться автотически, когда в радиусе сбора
- Когда предмет в радиусе сбора, то обводится белым контуром с плавной анимацией (первый раз писал шейдер, вухуу)

> На данном этапе прошло уже 3 дня. Основные сложности заключались в непонимании апихи годота, реализации анимаций и сложнее всего было соединить все сигналы между разными обьектами так, чтобы в момент рендера и появление обьектов, они могли все считаться, было непонятно, когда что отрисовывается, оказалось, что если обьект спавнится внутри Area2D, на которой висит area_entered, то обьект не будет прочитан, а так же различные собственные ошибки в алгоритмах
>
> Короче это сложнее, чем казалось
>
> НО! Будь я опытным разработчиком, то 100% сделал бы все за 2 дня.

## Инвентарь

- На Tab можно открыть инвентарь
- Когда предметы подбираются, то сразу отображаются в инвентаре
- Каждый предмет находится в слоте, а в углу отображается количество
- (на самом деле это было пиздец как сложно сделать, я столько раз путался, ПОЧЕМУ В GODOT ТАКАЯ ПЛОХАЯ СИСТЕМА ТИПОВ? Я только изза этого ошибки допускал, когда нет проверки, что я передал `Dictionary`, а не `ItemRes`)
- Нарисовал текстуры для инвентаря (слоты, панель, углы, обводка)
- Анимация, когда добавляется предмет в инвентарь
- Тултипы при наведении на предмет

## Анимации

- Объект на уровне мигает, когда получает урон (`modulate`)
- Поворот меча при ударе (`rotation`)
- При выпадении лут разлетается в радиусе бывшего объекта (`position`, `modulate:a`)
- Лут обводится белым контуром, когда находится в радиусе подбора игрока (`shader_material/outline_width`, `shader_material/outline_color`)
- Лут летит в игрока, когда игрок его подбирает (`position`, `modulate:a`)
- Предмет в инвентаре пульсирует, когда добавляется (`scale`) и еще там фон появлется (`modulate`)
- Инвентарь исчезает/появляется при закрытии/открытии (`modulate`)
- Крафт исчезает/появляется при закрытии/открытии (`modulate`)

## Крафт

- Еще одно окно интерфейса
- Рецепты создаются отдельно конфигами (`RecipeRes`), как было с лутом
- Все рецепты хранятся в услоной бд (`RecipeDB`), куда все складывается при запуске игры из файлов в папочке (`код скана файлов`)
- В этот раз узнавал че такое `ScrollContainer`, `V- и H- BoxContainer` (как же игровым движкам не хватает флекса)
- В первом рецепте, чтобы сделать каменную стену, нужно 3 дерева и 2 ягоды (так и задумано, все правильно)
- В зависимости от доступности ингредиентов, кнопочка крафта может быть недоступна
- При крафте, искомые предметы удаляются, а новый добавляется (вдруг неочевидно)
- ~~короче вот такой вот бутерброд бля жрать хочу ух ебать 6 утра сколько я сидел~~
- Добавил еще кучу рецептов (6-ой день)

---

### ИЗВЕСТНЫЕ ОШИБКИ, НО НЕИЗВЕСТНО, ЧТО С НИМИ ДЕЛАТЬ

В web-билде:

- не работает инвентарь
- выпадает только дерево
- не работает крафт

Почему так? Я хз

---

# План действий

1. ~~**Движение:** Камера, игрок (CharacterBody2D), управление WASD (velocity).~~
2. ~~**Мышь:** Поворот игрока/оружия в сторону курсора (`look_at()`).~~
3. ~~**Атака (Конус):** Реализуй `Area2D` для меча, логику включения по нажатию кнопки, расчет попадания (dot product или простой луч).~~
4. ~~**Объекты:** Создай серый/зеленый объекты (StaticBody2D). Сделай их разрушение при попадании атаки, спавн "дропа" (нод с Sprite2D/ColorRect + Area2D для подбора).~~
   4.5. ~~**Дроп**: Когда Item удаляется, то на его месте должен появиться уменьшенный его вариант, который потом можно будет подбирать~~ \
   ~~Падает несколько обьектов в зависимости от min,max в разных позицих. Так же item плучаетс урон и имеет хп~~ \
   ~~Даже добавил анимацию разлета, когда ломаешь куст~~ \
   ~~Сделал таблицу лута с вариантивной настройкой лута для обектов~~ \

5. ~~**Подбор:** Добавь зону подбора у игрока, логику сбора дропа по кнопке (E) и добавления в *простую* структуру инвентаря (пока что просто `var inventory: Dictionary = {}`).~~
6. ~~**Инвентарь (UI):** Создай сцену UI с GridContainer (сетка слотов). Научись открывать/закрывать ее по Tab. Отображай пустые слоты. А когда предметы собираются, то отображай их в инвентаре, где одна клетка - один предмет с количеством в углу.~~
7. ~~**Инвентарь (Данные):** Свяжи структуру данных (`inventory`) с UI. Отображай иконки (пока ColorRect) собранных предметов в слотах.~~
8. **Инвентарь (Drag&Drop):** Реализуй базовый перетаскивание между слотами *внутри* инвентаря. Обновляй структуру данных.
9. ~~**Крафт:** Создай окно/панель рецептов. Реализуй ресурс `Recipe` и функцию проверки/выполнения крафта (по кнопке на рецепте). Добавь желтый предмет.~~
10. **Размещение:** Реализуй выбор предмета в инвентаре, превью, проверку коллизий, установку объекта на карту.
11. **Полировка:** Звуки, частицы при разрушении/установке, улучшение UI, ~~исправление багов.~~

# Вопрос

Шел 6-ой день, я застрял.

## Папочки

Стоит вопрос, а как лучше распределить по папочкам файлы игры? Изначально я решил, что не буду делать `scripts`, `scenes`, `assets` и тд. А наоборот есть `player`, значит у него в папочке будет скрипт, картинка, конфиги, все, что относится к игроку. Но появилась проблема с предметами.

Есть `items` - это все вещи, которые могут лежать в инвентаре. Они либо дропаются, либо перемещаются в карманах игрока. Потом я подумал, что если я туда спихну все, то запутаюсь очень быстро, поэтому в `items` буквально все неодушевленное, что есть в игре.

А значит в items есть:

- `objects` - все то, что "стоит" на сцене
- `crafts` - все то, что падает откуда угодно и используется в крафте. Потенциально, допустим, есть враг и с него падает кирка (да, прям так), тогда это тоже `craft`? А почему нет? Допустим ее можно чинить, тогда чинить просто крафтом. Что-то + кирка 80% = кирка 100%. Удобно с точки зрения проектирования рецептов. Все, что крафт - можно использовать в рецептах.

Но потом я узнал про `Resource`. И стало очевидно, что конфигами решается, что где и какое будет, а по папочкам это делать западло.

И встал вопрос: как все-таки делать эти гребанные папочки? Нет, я не буду смотри как у других, я хочу, чтобы удобно было для меня.

Я хочу, чтобы не заходя в конфиги, я по структуре проекта мог понять к какой категории относится тот или иной обьект хотя бы потому что у Godot ооооочень все плохо с типами. А еще очень неудобно читать ресурсы. В чем проблема была сделать YAML для конфига ресурсов, разрабы движка? А всякие ссылки и импорты хранить гдето в кэше проекта.

Например в items будем:

- `materials` - то, что можно крафтить
- `tools` - то, чем орудует игрок
- `weapons` - то, чем игрок атакует (то есть топором и киркой нельзя бить? ну бред, мне нравится как в Terraria)
- `objects` - то, что стоит на сцене
- `...` - что-нибудь еще новое

А если я скрафтил стену, то она где? Пока это предмет, то это, ммм, `material`? Ну нет же. Это `placeable`, но не делать же еще одну категорию...

Значит остается как было в items:

- `crafts` (стена в инвентаре тут)
- `objects` (стена на сцене тут)

А это значит, что у стены будет две одинаковых по названию, но разных по сути папочки:

- `~./items/crafts/wall`, где
- - `wall_item.png`
- - `wall_item.tres`
- `~./items/objects/wall`, где
- - `wall_object.png`
- - `wall_object.tres`
- `recipes`, где
- - `wall_recipe.tres`

Тогда можно оставить `items` только для предметов, а для обьектов - `objects`. И со временем в `items` все равно будет нечитаемая каша. И категории все равно будут у предметов в Resource, например...

`items`:

- `material` - то, из чего крафтится
- `tool` - то, чем орудует игрок
- `moment/potion/one-hit/one-time/consume` - че-то, что можно использовать один раз, типа зелья или еды
- `placeable/building` - то, что можно потом поставить и оно станет object

> это тоже геймдев, посоны

Что не так с `materials, placeable, etc.`? То, что стена может быть и там, и там. Если я захочу потом сделать из стены крутую стену, то мне придется менять структуру. Поэтому все изначально и было тупо в папочке `crafts`. Просто и мусорно. Значит вообще все, кроме юзабельных вещей лежит в materials, а у них уже есть категориии...

```gdscript
class_name ItemRes
extends Resource

@export_category("Main")
@export var id: String = ""
@export var name: String = ""
@export var texture: Texture2D
@export_enum("material", "tool", "consume", "seed") var category: String = ""
@export_enum("placeable", "undestructable") var tags: Array[String] = []
@export_category("Optional")
@export_multiline var desc: String = ""
```

```gd
class_name ConsumeItemRes
extends ItemRes

@export_category("Consume")
@export var heal: int
@export var cooldown: float
```

Вот и решили вопрос. Всего-то час размышлений в стол.
